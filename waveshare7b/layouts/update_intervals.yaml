# update_intervals.yaml - Live entity state updates
# Consolidated into single lambdas to minimize LVGL overhead and improve responsiveness

# Fast updates: keypad (needs instant feedback) + alarm countdown
- interval: 500ms
  then:
    - lambda: |-
        // Keypad Code Display
        std::string code = id(entered_code);
        std::string display = "";
        for (size_t i = 0; i < code.length() && i < 6; i++) display += "* ";
        if (display.empty()) display = "_ _ _ _";
        lv_label_set_text(id(code_display), display.c_str());

        // Alarm countdowns (only render when pending)
        if (id(alarm_state).has_state() && id(alarm_state).state == "pending") {
          const char* countdown = "Arming...";
          char buf[20];
          if (id(alarm_delay_time).has_state()) {
            int s = (int)id(alarm_delay_time).state;
            if (s > 0) { snprintf(buf, sizeof(buf), "%d seconds", s); countdown = buf; }
          }
          lv_label_set_text(id(alarm_countdown_detail), countdown);
          lv_label_set_text(id(alarm_countdown_main), countdown);
        } else {
          lv_label_set_text(id(alarm_countdown_detail), "");
          lv_label_set_text(id(alarm_countdown_main), "");
        }

# Main updates: all entity states (5s is plenty for status display)
- interval: 5s
  then:
    - lambda: |-
        char buf[20];
        lv_color_t green   = lv_color_hex(0x30D158);
        lv_color_t red     = lv_color_hex(0xFF453A);
        lv_color_t gray    = lv_color_hex(0x8E8E93);
        lv_color_t yellow  = lv_color_hex(0xFFD700);
        lv_color_t orange  = lv_color_hex(0xFF9F0A);

        // ── WiFi Signal Bars ──
        float signal = id(wifi_signal_strength).state;
        lv_color_t c1 = green, c2 = gray, c3 = gray, c4 = gray;
        if (signal > -50) { c1 = c2 = c3 = c4 = green; }
        else if (signal > -60) { c1 = c2 = c3 = green; }
        else if (signal > -70) { c1 = c2 = green; }
        else { c1 = green; }
        lv_obj_set_style_bg_color(id(wifi_bar_1), c1, 0);
        lv_obj_set_style_bg_color(id(wifi_bar_2), c2, 0);
        lv_obj_set_style_bg_color(id(wifi_bar_3), c3, 0);
        lv_obj_set_style_bg_color(id(wifi_bar_4), c4, 0);

        // ── Clock ──
        auto t = id(ha_time).now();
        if (t.is_valid()) {
          snprintf(buf, sizeof(buf), "%02d:%02d", t.hour, t.minute);
          lv_label_set_text(id(last_update_time), buf);
        }

        // ── Temperatures ──
        if (id(outside_temp_sensor).has_state()) {
          snprintf(buf, sizeof(buf), "%.0f°F", id(outside_temp_sensor).state);
          lv_label_set_text(id(outside_temp_main), buf);
        }
        if (id(inside_temp_sensor).has_state()) {
          snprintf(buf, sizeof(buf), "%.0f°F", id(inside_temp_sensor).state);
          lv_label_set_text(id(inside_temp_main), buf);
        }

        // ── Alarm Status ──
        if (id(alarm_state).has_state()) {
          std::string s = id(alarm_state).state;
          const char* label = "Unknown";
          lv_color_t color = gray;
          if (s == "disarmed") { label = "DISARMED"; color = gray; }
          else if (s == "armed_away") { label = "ARMED AWAY"; color = green; }
          else if (s == "armed_home") { label = "ARMED HOME"; color = green; }
          else if (s == "armed_night") { label = "ARMED NIGHT"; color = green; }
          else if (s == "armed_vacation") { label = "ARMED VACATION"; color = green; }
          else if (s == "armed_custom_bypass") { label = "ARMED CUSTOM"; color = green; }
          else if (s == "pending") { label = "ARMING..."; color = orange; }
          else if (s == "triggered") { label = "TRIGGERED!"; color = red; }
          lv_label_set_text(id(alarm_status_main), label);
          lv_obj_set_style_text_color(id(alarm_status_main), color, 0);
          lv_label_set_text(id(alarm_status_detail), label);
          lv_obj_set_style_text_color(id(alarm_status_detail), color, 0);
        }

        // ── Open Sensors Warning ──
        bool has_open = false;
        std::string list = "";
        if (id(garage_door_open).has_state() && id(garage_door_open).state) { has_open = true; list += "Garage  "; }
        if (id(back_door_sensor_open).has_state() && id(back_door_sensor_open).state) { has_open = true; list += "Back Door  "; }
        if (id(front_door_locked).has_state() && !id(front_door_locked).state) { has_open = true; list += "Front Unlocked  "; }
        if (id(back_door_locked).has_state() && !id(back_door_locked).state) { has_open = true; list += "Back Unlocked"; }
        if (has_open) {
          lv_obj_clear_flag(id(open_sensors_warning), LV_OBJ_FLAG_HIDDEN);
          lv_label_set_text(id(open_sensors_list), list.c_str());
        } else {
          lv_obj_add_flag(id(open_sensors_warning), LV_OBJ_FLAG_HIDDEN);
        }
        // Alarm page sensor list
        if (list.empty()) {
          lv_label_set_text(id(alarm_sensors_list), "All Secured");
          lv_obj_set_style_text_color(id(alarm_sensors_list), green, 0);
        } else {
          lv_label_set_text(id(alarm_sensors_list), list.c_str());
          lv_obj_set_style_text_color(id(alarm_sensors_list), red, 0);
        }

        // ── Front Door Lock ──
        if (id(front_door_locked).has_state()) {
          bool locked = id(front_door_locked).state;
          lv_color_t lc = locked ? green : red;
          lv_label_set_text(id(front_door_main), locked ? "Locked" : "Unlocked");
          lv_obj_set_style_text_color(id(front_door_main), lc, 0);
          lv_obj_set_style_text_color(id(front_door_icon_main), lc, 0);
          lv_label_set_text(id(front_door_status_locks), locked ? "Locked" : "Unlocked");
          lv_obj_set_style_text_color(id(front_door_status_locks), lc, 0);
          lv_obj_set_style_text_color(id(front_door_icon_locks), lc, 0);
        }
        if (id(front_door_sensor_open).has_state()) {
          bool open = id(front_door_sensor_open).state;
          lv_label_set_text(id(front_door_sensor_status), open ? "Door OPEN" : "Door Closed");
          lv_obj_set_style_text_color(id(front_door_sensor_status), open ? red : gray, 0);
        }

        // ── Back Door Lock ──
        if (id(back_door_locked).has_state()) {
          bool locked = id(back_door_locked).state;
          lv_color_t lc = locked ? green : red;
          lv_label_set_text(id(back_door_main), locked ? "Locked" : "Unlocked");
          lv_obj_set_style_text_color(id(back_door_main), lc, 0);
          lv_obj_set_style_text_color(id(back_door_icon_main), lc, 0);
          lv_label_set_text(id(back_door_status_locks), locked ? "Locked" : "Unlocked");
          lv_obj_set_style_text_color(id(back_door_status_locks), lc, 0);
          lv_obj_set_style_text_color(id(back_door_icon_locks), lc, 0);
        }
        if (id(back_door_sensor_open).has_state()) {
          bool open = id(back_door_sensor_open).state;
          lv_label_set_text(id(back_door_sensor_status), open ? "Door OPEN" : "Door Closed");
          lv_obj_set_style_text_color(id(back_door_sensor_status), open ? red : gray, 0);
        }

        // ── Garage Door ──
        if (id(garage_door_open).has_state()) {
          bool open = id(garage_door_open).state;
          const char* icon = open ? "\U000F12D4" : "\U000F12D3";
          lv_color_t gc = open ? orange : green;
          lv_label_set_text(id(garage_icon_main), icon);
          lv_obj_set_style_text_color(id(garage_icon_main), gc, 0);
          lv_label_set_text(id(garage_status_main), open ? "Open" : "Closed");
          lv_obj_set_style_text_color(id(garage_status_main), gc, 0);
          lv_label_set_text(id(garage_icon_locks), icon);
          lv_obj_set_style_text_color(id(garage_icon_locks), gc, 0);
          lv_label_set_text(id(garage_status_locks), open ? "Open" : "Closed");
          lv_obj_set_style_text_color(id(garage_status_locks), gc, 0);
          lv_label_set_text(id(garage_quick_icon), icon);
          lv_obj_set_style_text_color(id(garage_quick_icon), gc, 0);
        }

        // ── Security Summary ──
        {
          bool any = false;
          if (id(front_door_locked).has_state() && !id(front_door_locked).state) any = true;
          if (id(back_door_locked).has_state() && !id(back_door_locked).state) any = true;
          if (id(garage_door_open).has_state() && id(garage_door_open).state) any = true;
          lv_label_set_text(id(security_summary), any ? "Open / Unsecured" : "All Secured");
          lv_obj_set_style_text_color(id(security_summary), any ? red : green, 0);
        }

        // ── Living Room Light ──
        if (id(living_room_light_state).has_state()) {
          bool on = id(living_room_light_state).state;
          lv_color_t lc = on ? yellow : gray;
          lv_label_set_text(id(living_room_main), on ? "ON" : "OFF");
          lv_obj_set_style_text_color(id(living_room_main), lc, 0);
          lv_obj_set_style_text_color(id(living_room_icon_main), lc, 0);
          lv_label_set_text(id(living_room_toggle_text), on ? "ON" : "OFF");
          lv_obj_set_style_text_color(id(living_room_toggle_text), lc, 0);
          lv_obj_set_style_text_color(id(living_room_light_icon), lc, 0);
        }

        // ── Kitchen Light ──
        if (id(kitchen_light_state).has_state()) {
          bool on = id(kitchen_light_state).state;
          lv_color_t lc = on ? yellow : gray;
          lv_label_set_text(id(kitchen_toggle_text), on ? "ON" : "OFF");
          lv_obj_set_style_text_color(id(kitchen_toggle_text), lc, 0);
          lv_obj_set_style_text_color(id(kitchen_light_icon), lc, 0);
        }

        // ── Outdoor Light ──
        if (id(outdoor_light_state).has_state()) {
          bool on = id(outdoor_light_state).state;
          lv_color_t lc = on ? yellow : gray;
          lv_label_set_text(id(outdoor_toggle_text), on ? "ON" : "OFF");
          lv_obj_set_style_text_color(id(outdoor_toggle_text), lc, 0);
          lv_obj_set_style_text_color(id(outdoor_light_icon), lc, 0);
        }
