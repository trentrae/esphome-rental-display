# device.yaml - Waveshare ESP32-S3-Touch-LCD-7B
# Resolution: 1024x600 | ST7262E43 RGB Parallel | GT911 Touch
#
# ⚠️  PIN SHARING NOTE: On the 7B, GPIO4/8/9 are shared between the I2C touch
#     bus and the RGB data bus. ESPHome can't use the same GPIO for two
#     peripherals simultaneously. The workaround:
#       - GT911 runs in POLLING mode (no interrupt_pin) to free GPIO4 for display.
#       - I2C SDA/SCL are set to GPIO19/GPIO20 which are free on most 7B revisions.
#       - If your board revision wires touch I2C to GPIO8/9, you may need to
#         remove B0 and B3 from data_pins (reduces blue depth to 3 bits).
#     Verify your specific board revision against the Waveshare schematic.
#
# ⚠️  BACKLIGHT NOTE: The 7B uses a CH32V003 MCU to control backlight/brightness.
#     ESPHome has no native driver for it yet (feature request #3202 open as of 2025).
#     The display will work at full brightness. Use lvgl.pause on a timer for
#     screen-saver / anti-burn protection instead.

esp32:
  board: esp32-s3-devkitc-1
  variant: esp32s3
  flash_size: 16MB
  framework:
    type: esp-idf
    version: recommended
    sdkconfig_options:
      CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240: "y"
      CONFIG_ESP32S3_DATA_CACHE_64KB: "y"
      CONFIG_ESP32S3_DATA_CACHE_LINE_64B: "y"
      CONFIG_SPIRAM_FETCH_INSTRUCTIONS: "y"
      CONFIG_SPIRAM_RODATA: "y"
      CONFIG_ESP32S3_INSTRUCTION_CACHE_32KB: "y"

psram:
  mode: octal
  speed: 80MHz

# I2C for GT911 touch controller
# ⚠️  If your board rev wires touch I2C to GPIO8/9 instead of GPIO19/20,
#     change sda/scl below and remove GPIO8 & GPIO9 from the display data_pins.
i2c:
  - id: i2c_touch
    sda: GPIO19
    scl: GPIO20
    frequency: 400kHz

# GT911 Capacitive Touch (polling mode - no interrupt_pin to avoid GPIO4 conflict)
touchscreen:
  - platform: gt911
    id: my_touch
    i2c_id: i2c_touch
    reset_pin: GPIO38
    on_touch:
      - lambda: |-
          id(idle_seconds) = 0;
      - if:
          condition:
            lvgl.is_paused:
          then:
            - lvgl.resume:
            - lvgl.widget.redraw:

# RGB Parallel Display - ST7701 1024x600
display:
  - platform: rpi_dpi_rgb
    id: my_display
    auto_clear_enabled: false
    update_interval: never
    color_order: RGB
    pclk_frequency: 30MHz
    dimensions:
      width: 1024
      height: 600
    de_pin: GPIO40
    hsync_pin: GPIO39
    vsync_pin: GPIO41
    pclk_pin: GPIO42
    hsync_back_porch: 8
    hsync_front_porch: 8
    hsync_pulse_width: 4
    vsync_back_porch: 8
    vsync_front_porch: 8
    vsync_pulse_width: 4
    data_pins:
      red:
        - GPIO45   # R0
        - GPIO48   # R1
        - GPIO47   # R2
        - GPIO21   # R3
        - GPIO14   # R4
      green:
        - GPIO5    # G0
        - GPIO6    # G1
        - GPIO7    # G2
        - GPIO15   # G3
        - GPIO16   # G4
        - GPIO4    # G5 (freed by using polling-mode touch)
      blue:
        - GPIO8    # B0
        - GPIO3    # B1
        - GPIO46   # B2
        - GPIO9    # B3
        - GPIO1    # B4
