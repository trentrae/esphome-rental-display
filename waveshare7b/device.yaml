# device.yaml - Waveshare ESP32-S3-Touch-LCD-7B
# Resolution: 1024x600 | RGB Parallel | GT911 Touch
# Pin assignments and backlight control based on working reference:
#   github.com/agillis/esphome-modular-lvgl-buttons

esp32:
  board: esp32-s3-devkitc-1
  variant: esp32s3
  flash_size: 16MB
  framework:
    type: esp-idf
    version: recommended
    sdkconfig_options:
      CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240: "y"
      CONFIG_ESP32S3_DATA_CACHE_64KB: "y"
      CONFIG_ESP32S3_DATA_CACHE_LINE_64B: "y"
      CONFIG_SPIRAM_FETCH_INSTRUCTIONS: "y"
      CONFIG_SPIRAM_RODATA: "y"
      CONFIG_ESP32S3_INSTRUCTION_CACHE_32KB: "y"

psram:
  mode: octal
  speed: 80MHz

preferences:
  flash_write_interval: 5min

# -------------------------------------------
# IO Extender - CH32V003 (backlight, resets)
# -------------------------------------------
external_components:
  - source: github://pr#10071
    components: [waveshare_io_ch32v003]
    refresh: 1h

waveshare_io_ch32v003:
  - id: waveshare_io_hub

# -------------------------------------------
# LCD Backlight (via IO expander)
# -------------------------------------------
output:
  - platform: waveshare_io_ch32v003
    id: backlight_output

  - platform: waveshare_io_ch32v003
    id: pwm_backlight_output
    inverted: true
    min_power: 0.03
    max_power: 1.0

switch:
  - platform: gpio
    internal: true
    id: exio2
    restore_mode: ALWAYS_ON
    pin:
      waveshare_io_ch32v003: waveshare_io_hub
      number: 2
      mode:
        output: true

light:
  - platform: monochromatic
    output: pwm_backlight_output
    name: Display Backlight
    icon: mdi:lightbulb-on
    id: display_backlight
    restore_mode: ALWAYS_ON
    default_transition_length: 250ms
    on_turn_on:
      then:
        - switch.turn_on: exio2
    on_turn_off:
      then:
        - switch.turn_off: exio2

# -------------------------------------------
# I2C bus (GT911 touch + IO expander)
# -------------------------------------------
i2c:
  - id: bus_a
    sda: GPIO08
    scl: GPIO09
    scan: true

# -------------------------------------------
# GT911 Capacitive Touchscreen
# -------------------------------------------
touchscreen:
  - platform: gt911
    id: my_touch
    display: my_display
    i2c_id: bus_a
    interrupt_pin: GPIO4
    reset_pin:
      waveshare_io_ch32v003: waveshare_io_hub
      number: 1
      mode: OUTPUT
    on_touch:
      - lambda: |-
          id(idle_seconds) = 0;
      - if:
          condition:
            lvgl.is_paused:
          then:
            - lvgl.resume:
            - lvgl.widget.redraw:
            - light.turn_on: display_backlight

# -------------------------------------------
# RGB Parallel Display - 1024x600
# -------------------------------------------
display:
  - platform: rpi_dpi_rgb
    id: my_display
    auto_clear_enabled: false
    update_interval: never
    color_order: RGB
    pclk_frequency: 30MHz
    pclk_inverted: true
    dimensions:
      width: 1024
      height: 600
    de_pin:
      number: 5
    hsync_pin:
      number: 46
      ignore_strapping_warning: true
    vsync_pin:
      number: 3
      ignore_strapping_warning: true
    pclk_pin: 7
    reset_pin:
      waveshare_io_ch32v003: waveshare_io_hub
      number: 3
    hsync_back_porch: 152
    hsync_front_porch: 48
    hsync_pulse_width: 162
    vsync_back_porch: 13
    vsync_front_porch: 3
    vsync_pulse_width: 45
    data_pins:
      red:
        - 1         # R3
        - 2         # R4
        - 42        # R5
        - 41        # R6
        - 40        # R7
      green:
        - 39        # G2
        - 0         # G3
        - 45        # G4
        - 48        # G5
        - 47        # G6
        - 21        # G7
      blue:
        - 14        # B3
        - 38        # B4
        - 18        # B5
        - 17        # B6
        - 10        # B7
